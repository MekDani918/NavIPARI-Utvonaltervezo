import*as THREE from"https://cdn.skypack.dev/-/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/dist=es2020,mode=imports,min/optimized/three.js";import{OrbitControls}from"./OrbitControls.js";import{SVGLoader}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/SVGLoader.js";import{FontLoader}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/FontLoader.js";import{TextGeometry}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/geometries/TextGeometry.js";import{LineGeometry}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/LineGeometry.js";import{LineMaterial}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/LineMaterial.js";import{Line2}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/Line2.js";var mapDivWidth,mapDivHeight,_scene,_camera,_renderer,_controls,cube,_svg_loader,_guiData,FloorURLs=["./svg/001-foldszint.svg","./svg/002-emelet1.svg","./svg/003-emelet2.svg","./svg/004-I-epulet-padlaster.svg"],lastZoomVal=0,_Rooms=[],_Nodes=[],_Path=[],_Lines=[],_Icons=[],lineMaterial=new LineMaterial({color:255,linewidth:10,depthWrite:!0});async function init(){updateWindowSize(),_scene=new THREE.Scene,_camera=new THREE.PerspectiveCamera(75,window.outerWidth/window.outerHeight,1,1e3),(_renderer=new THREE.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),_renderer.setSize(window.outerWidth,window.outerHeight),document.getElementById("mapDiv").appendChild(_renderer.domElement),_camera.position.z=200,_camera.lookAt(0,0,0),(_controls=new OrbitControls(_camera,_renderer.domElement)).enableRotate=!1,_controls.minDistance=25,_controls.maxDistance=500,_controls.zoomSpeed=2,_controls.mouseButtons={LEFT:THREE.MOUSE.PAN,MIDDLE:THREE.MOUSE.DOLLY,RIGHT:THREE.MOUSE.PAN},_controls.touches={ONE:THREE.TOUCH.PAN,TWO:THREE.TOUCH.DOLLY_PAN},loadSVG((_guiData={currentURL:"./svg/001-foldszint.svg",currentFloor:{number:1,path:"./svg/001-foldszint.svg"},drawFillShapes:!0,drawStrokes:!0,fillShapesWireframe:!1,strokesWireframe:!1}).currentURL),loadIcons(),document.getElementById("zoomBtnGroup").addEventListener("click",e=>{zoomModel("+"==("svg"==e.target.tagName?e.target.parentElement:"path"==e.target.tagName?e.target.parentElement.parentElement:e.target).value,.95*_controls.getZoomScale())}),window.requestAnimationFrame(animate),await createFloorBtns(),initCollapseBtns(),await getNodeList(),await getRoomList(),document.getElementById("selected-option-from").addEventListener("click",toggleDropdown),document.getElementById("fromPlace").addEventListener("input",updateDropdown),document.getElementById("selected-option-to").addEventListener("click",toggleDropdown),document.getElementById("toPlace").addEventListener("input",updateDropdown),document.getElementById("swFromTo").addEventListener("click",swFromTo),document.getElementById("planRoute").addEventListener("click",planRoute),showRoute()}function toggleDropdown(e){let t=e.target.parentElement.getElementsByClassName("dropdown-container")[0];for(let e of document.getElementsByClassName("dropdown-container"))e!=t&&e.classList.contains("dropdown-visible")&&e.classList.remove("dropdown-visible");let o=t.querySelector(".form-control");t.classList.contains("dropdown-visible")||(initRoomDropdown(t,""),o.value=""),t.classList.toggle("dropdown-visible"),o.focus()}async function getNodeList(){let e=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getNodes"})});for(let t of e)_Nodes.push(new NODE(t.ID,t.POS_X,t.POS_Y,t.FLOOR,1==t.IS_STAIR,t.NEIGHBOURS));for(let e of _Nodes)e.neighbourNodeList=_Nodes.filter(t=>e.NeighbourIDList.includes(t.ID))}async function getRoomList(){(_Rooms=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getRooms"})})).sort((e,t)=>e.NAME>t.NAME?1:t.NAME>e.NAME?-1:0);for(let e of _Rooms){let t=[];for(let o of e.ALIASES)t.push(o.ALIAS);e.ALIASES=t}}function updateDropdown(e){initRoomDropdown(e.target.parentElement,e.target.value)}function initRoomDropdown(e,t){let o=e.querySelector(".option-container");o.innerHTML="";for(let e of _Rooms){let n=aliaslistMatch(e.ALIASES,t);if(t.trim().length<1||e.NAME.toLowerCase().includes(t.toLowerCase())||n.length>0){let t=document.createElement("li");if(t.classList="list-group-item",t.innerHTML=e.NAME,t.value=e.ID,e.ALIASES.length>0){let o=document.createElement("p");o.classList="m-0 p-0 text-muted",o.innerHTML=`(${e.ALIASES.join(", ")})`,t.appendChild(o)}t.addEventListener("click",dropdownItemClicked),o.appendChild(t)}}}function dropdownItemClicked(e){let t="LI"==e.target.tagName?e.target:e.target.parentElement,o=t.parentElement.parentElement.parentElement.querySelector(".selected-option-container"),n=_Rooms.find(e=>e.ID==t.value);o.innerHTML=n.NAME,o.value=n.ID,toggleDropdown({target:t.parentElement.parentElement})}function aliaslistMatch(e,t){let o=[];for(let n of e)n.toLowerCase().includes(t.toLowerCase())&&o.push(n);return o}function initCollapseBtns(){for(let e of document.getElementsByClassName("collapseBtnS"))e.addEventListener("click",toggleCollapse)}function toggleCollapse(){let e=document.getElementById("menuDiv");e.classList.contains("collapsed")?e.classList.remove("collapsed"):e.classList.add("collapsed")}function loadSVG(e){(_scene=new THREE.Scene).background=new THREE.Color(11579568),(_svg_loader=new SVGLoader).load(e,function(e){const t=e.paths,o=new THREE.Group;o.scale.multiplyScalar(.5),o.scale.y*=-1;for(let e=0;e<t.length;e++){const n=t[e],i=n.userData.style.fill;if(_guiData.drawFillShapes&&void 0!==i&&"none"!==i){const e=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(i),opacity:n.userData.style.fillOpacity,transparent:n.userData.style.fillOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),t=SVGLoader.createShapes(n);for(let i=0;i<t.length;i++){const s=t[i],r=new THREE.ShapeGeometry(s),a=new THREE.Mesh(r,e);""!=n.userData.node.id&&createLabel(n,a,o),o.add(a)}}const s=n.userData.style.stroke;if(_guiData.drawStrokes&&void 0!==s&&"none"!==s){const e=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(s),opacity:n.userData.style.strokeOpacity,transparent:n.userData.style.strokeOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let t=0,i=n.subPaths.length;t<i;t++){const i=n.subPaths[t],s=SVGLoader.pointsToStroke(i.getPoints(),n.userData.style);if(s){const t=new THREE.Mesh(s,e);o.add(t)}}}}(new THREE.Box3).setFromObject(o).getCenter(o.position).multiplyScalar(-1),_scene.add(o),setTimeout(()=>{document.getElementById("loadingSc").classList.add("hideLoading"),setTimeout(()=>{document.getElementById("loadingSc").style.display="none"},250)},250),_scene.add(o)})}function createLabel(e,t,o){(new FontLoader).load("./fonts/Open Sans_Regular.json",function(n){let i=e.userData.node.id.split("_x3B_")[0].replaceAll("_x2C_",",").replaceAll("_x28_","(").replaceAll("_x29_",")").replace(/_[0-9]*_/,"").replaceAll("_"," ");const s=new TextGeometry(i,{font:n,size:5,height:1,curveSegments:10,bevelEnabled:!1,bevelOffset:0,bevelSegments:1,bevelSize:.3,bevelThickness:1}),r=[new THREE.MeshPhongMaterial({color:16737792}),new THREE.MeshPhongMaterial({color:255})];var a=new THREE.Mesh(s,r);a.castShadow=!1;var l=t.geometry;l.computeBoundingBox();var d=new THREE.Vector3;l.boundingBox.getCenter(d);var c=a.geometry;c.computeBoundingBox();var u=c.boundingBox.min,p=c.boundingBox.max;a.position.x=d.x,a.position.x-=(p.x-u.x)/2,a.position.y=d.y,a.position.y+=(p.y-u.y)/3,a.scale.y*=-1,a.scale.z=.1;let m=new THREE.Vector3;l.boundingBox.getSize(m);let g=new THREE.Vector3;if(c.boundingBox.getSize(g),m.x<g.x)if(a.position.x=d.x,a.position.y=d.y,m.x<m.y)if(a.rotation.z=Math.PI/2,m.y<g.x){let e=Math.floor(m.y/g.x*10)/10.25;a.scale.x*=e,a.scale.y*=e,a.position.x-=(p.y-u.y)*e/3,a.position.y-=(p.x-u.x)*e/2}else a.position.x-=(p.y-u.y)/3,a.position.y-=(p.x-u.x)/2;else{let e=Math.floor(m.x/g.x*10)/10.25;a.scale.x*=e,a.scale.y*=e,a.position.x-=(p.x-u.x)*e/2,a.position.y+=(p.y-u.y)*e/3}o.add(a)})}function showRoute(){if(!_Path||_Path.length<2)return;removeIcons(),drawLine([..._Path]),_Path[0].Floor==_guiData.currentFloor.number&&drawIcon("start_icon",new THREE.Vector3(_Path[0].PosX,_Path[0].PosY,-1));let e=_Path[_Path.length-1];e.Floor==_guiData.currentFloor.number&&drawIcon("dest_icon3",new THREE.Vector3(e.PosX,e.PosY,-1))}function drawIcon(e,t=new THREE.Vector3(0,0,.1)){let o=_Icons.find(t=>t.name==e);null!=o&&(_scene.add(o.group),o.visible=!0,o.position=t)}function removeIcons(){for(let e of _Icons)_scene.children.includes(e.group)&&(e.visible=!1,_scene.remove(e.group))}function loadIcons(){let e=["start_icon","dest_icon3"];for(let t of e)_Icons.push(new ICON(t))}function loadIcon(e){(_svg_loader=new SVGLoader).load(`./svg/icons/${e}.svg`,function(t){const o=t.paths,n=new THREE.Group;n.scale.multiplyScalar(.045),n.scale.y*=-1,n.name=e;for(let e=0;e<o.length;e++){const t=o[e],i=t.userData.style.fill,s=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(i),opacity:t.userData.style.fillOpacity,transparent:t.userData.style.fillOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),r=SVGLoader.createShapes(t);for(let e=0;e<r.length;e++){const t=r[e],o=new THREE.ShapeGeometry(t),i=new THREE.Mesh(o,s);n.add(i)}const a=t.userData.style.stroke,l=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(a),opacity:t.userData.style.strokeOpacity,transparent:t.userData.style.strokeOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let e=0,o=t.subPaths.length;e<o;e++){const o=t.subPaths[e],i=SVGLoader.pointsToStroke(o.getPoints(),t.userData.style);if(i){const e=new THREE.Mesh(i,l);n.add(e)}}}_Icons.push(n),_scene.add(n)})}function drawLine(e){if(e.length<2)return;for(let e of _Lines)_scene.remove(e);let t=[];for(;e.length>0;){let o=e.findIndex(t=>t.Floor!=e[0].Floor);o=o<0?e.length:o,t.push(e.splice(0,o))}let o=[];for(let e of t)if(e[0].Floor==_guiData.currentFloor.number){let t=[];for(let o of e)t.push(o.PosX,o.PosY,.05);o.push(t)}for(let e of o){const t=new LineGeometry;t.setPositions(e),t.setColors(new THREE.Color(65280));let o=new Line2(t,lineMaterial);o.computeLineDistances(),o.scale.set(1,1,1),_Lines.push(o),_scene.add(o)}}function zoomModel(e,t){e?_controls.dollyIn(t):_controls.dollyOut(t)}function animate(){_controls.update(),lineMaterial.resolution.set(window.innerWidth,window.innerHeight),_renderer.render(_scene,_camera),window.requestAnimationFrame(animate)}function onWindowResize(){updateWindowSize(),_camera.aspect=window.outerWidth/window.outerHeight,_camera.updateProjectionMatrix(),_renderer.setSize(window.outerWidth,window.outerHeight)}function updateWindowSize(){mapDivWidth=window.innerWidth,mapDivHeight=window.innerHeight}async function createFloorBtns(){FloorURLs=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getFloors"})});let e=document.getElementById("floorBtnGroup");for(let t in FloorURLs){let o=document.createElement("button");o.value=t,o.innerHTML=FloorURLs[t].number,o.classList="btn text-dark btn-floor",1==FloorURLs[t].number&&o.classList.add("active"),o.addEventListener("click",changeFloor),e.appendChild(o)}}function changeFloor(e){if(FloorURLs[e.target.value].path!=_guiData.currentURL&&(document.getElementById("loadingSc").style.display="block",document.getElementById("loadingSc").classList.remove("hideLoading"),_controls.reset(),FloorURLs[e.target.value].path!=_guiData.currentURL)){removeIcons(),_guiData.currentFloor=FloorURLs[e.target.value],_guiData.currentURL=_guiData.currentFloor.path,loadSVG(_guiData.currentURL);for(let t of document.querySelectorAll(".btn-floor"))t.classList.remove("active"),t.value==e.target.value&&t.classList.add("active");_renderer.render(_scene,_camera),showRoute(),_renderer.render(_scene,_camera)}}function swFromTo(){let e=document.getElementById("selected-option-from"),t=document.getElementById("selected-option-to");if(null==e.value&&null==t.value)return;let o=e.value,n=e.innerHTML;e.value=t.value,e.innerHTML=t.innerHTML,t.value=o,t.innerHTML=n,null==e.value&&(e.innerHTML="Válassza ki honnan indul"),null==t.value&&(t.innerHTML="Válassza ki hova szeretne eljutni")}function planRoute(e){e.preventDefault();let t=document.getElementById("selected-option-from").value,o=document.getElementById("selected-option-to").value;if(null==t||t<0||null==o||o<0)return;let n=_Rooms.find(e=>e.ID==t),i=_Rooms.find(e=>e.ID==o),s=_Nodes.find(e=>e.ID==n.NODE_ID),r=_Nodes.find(e=>e.ID==i.NODE_ID);_Path=bfs(s,r),_guiData.currentFloor.number==_Path[0].Floor?showRoute():changeFloor({target:{value:FloorURLs.findIndex(e=>e.number==_Path[0].Floor)}}),toggleCollapse()}async function getData(e,t){let o;return o=t?await fetch(e,t):await fetch(e),await o.json()}function bfs(e,t){for(let e of _Nodes)e.isVisited=!1,e.prevNode=null;let o=[e];for(e.isVisited=!0;0==!o.length;){let e=o.splice(0,1)[0];for(let t of e.neighbourNodeList)t.isVisited||(o.push(t),t.isVisited=!0,t.prevNode=e)}let n=[];for(let e=t;null!=e;e=e.prevNode)n.push(e);return n.reverse(),n[0]==e?n:[]}window.addEventListener("resize",onWindowResize),window.addEventListener("load",init);class NODE{constructor(e,t,o,n,i=!1,s=[]){this.ID=e,this.PosX=parseFloat(t),this.PosY=parseFloat(o),this.Floor=n,this.IsStair=i,this.NeighbourIDList=[];for(let e of s)this.NeighbourIDList.push(e.ID);this.neighbourNodeList=[]}}class ICON{constructor(e,t=0,o=0){this.offsetX=4.73,this.offsetY=11.75,this.group=new THREE.Group,this.loadSVGFile(e,t,o)}loadSVGFile(e,t,o){_svg_loader=new SVGLoader,this.group=new THREE.Group,this.group.scale.multiplyScalar(.055),this.group.scale.y*=-1,this.group.visible=!1,this.group.renderOrder=99,this.group.name=e,_svg_loader.loadAsync(`./svg/icons/${e}.svg`).then(e=>{this.loaderFunction(e),this.position=new THREE.Vector3(t,o,.25)})}loaderFunction(e){const t=e.paths;for(let e=0;e<t.length;e++){const o=t[e],n=o.userData.style.fill,i=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(n),opacity:o.userData.style.fillOpacity,transparent:o.userData.style.fillOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),s=SVGLoader.createShapes(o);for(let e=0;e<s.length;e++){const t=s[e],o=new THREE.ShapeGeometry(t),n=new THREE.Mesh(o,i);this.group.add(n)}const r=o.userData.style.stroke,a=new THREE.MeshBasicMaterial({color:(new THREE.Color).setStyle(r),opacity:o.userData.style.strokeOpacity,transparent:o.userData.style.strokeOpacity<1,side:THREE.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let e=0,t=o.subPaths.length;e<t;e++){const t=o.subPaths[e],n=SVGLoader.pointsToStroke(t.getPoints(),o.userData.style);if(n){const e=new THREE.Mesh(n,a);this.group.add(e)}}}}get name(){return this.group.name}get position(){return this.group.position}set position(e){this.group.position.set(e.x-this.offsetX,e.y+this.offsetY,.1)}get visible(){return this.group.visible}set visible(e){this.group.visible=e}}