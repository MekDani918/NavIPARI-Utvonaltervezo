import*as e from"https://cdn.skypack.dev/-/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/dist=es2020,mode=imports,min/optimized/three.js";import{OrbitControls as t}from"./OrbitControls.js";import{SVGLoader as o}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/SVGLoader.js";import{FontLoader as n}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/FontLoader.js";import{TextGeometry as i}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/geometries/TextGeometry.js";import{LineGeometry as s}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/LineGeometry.js";import{LineMaterial as r}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/LineMaterial.js";import{Line2 as a}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/lines/Line2.js";var mapDivWidth,mapDivHeight,_scene,_camera,_renderer,_controls,cube,_svg_loader,_guiData,FloorURLs=["./svg/001-foldszint.svg","./svg/002-emelet1.svg","./svg/003-emelet2.svg","./svg/004-I-epulet-padlaster.svg"],lastZoomVal=0,_Rooms=[],_Nodes=[],_Path=[],_Lines=[],_Icons=[],lineMaterial=new r({color:255,linewidth:10,depthWrite:!0});async function init(){updateWindowSize(),_scene=new e.Scene,_camera=new e.PerspectiveCamera(75,window.outerWidth/window.outerHeight,1,1e3),(_renderer=new e.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),_renderer.setSize(window.outerWidth,window.outerHeight),document.getElementById("mapDiv").appendChild(_renderer.domElement),_camera.position.z=200,_camera.lookAt(0,0,0),(_controls=new t(_camera,_renderer.domElement)).enableRotate=!1,_controls.minDistance=25,_controls.maxDistance=500,_controls.zoomSpeed=2,_controls.mouseButtons={LEFT:e.MOUSE.PAN,MIDDLE:e.MOUSE.DOLLY,RIGHT:e.MOUSE.PAN},_controls.touches={ONE:e.TOUCH.PAN,TWO:e.TOUCH.DOLLY_PAN},loadSVG((_guiData={currentURL:"./svg/001-foldszint.svg",currentFloor:{number:1,path:"./svg/001-foldszint.svg"},drawFillShapes:!0,drawStrokes:!0,fillShapesWireframe:!1,strokesWireframe:!1}).currentURL),loadIcons(),document.getElementById("zoomBtnGroup").addEventListener("click",e=>{zoomModel("+"==("svg"==e.target.tagName?e.target.parentElement:"path"==e.target.tagName?e.target.parentElement.parentElement:e.target).value,.95*_controls.getZoomScale())}),window.requestAnimationFrame(animate),await createFloorBtns(),initCollapseBtns(),await getNodeList(),await getRoomList(),document.getElementById("selected-option-from").addEventListener("click",toggleDropdown),document.getElementById("fromPlace").addEventListener("input",updateDropdown),document.getElementById("selected-option-to").addEventListener("click",toggleDropdown),document.getElementById("toPlace").addEventListener("input",updateDropdown),document.getElementById("swFromTo").addEventListener("click",swFromTo),document.getElementById("planRoute").addEventListener("click",planRoute),showRoute()}function toggleDropdown(e){let t=e.target.parentElement.getElementsByClassName("dropdown-container")[0];for(let o of document.getElementsByClassName("dropdown-container"))o!=t&&o.classList.contains("dropdown-visible")&&o.classList.remove("dropdown-visible");let n=t.querySelector(".form-control");t.classList.contains("dropdown-visible")||(initRoomDropdown(t,""),n.value=""),t.classList.toggle("dropdown-visible"),n.focus()}async function getNodeList(){let e=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getNodes"})});for(let t of e)_Nodes.push(new NODE(t.ID,t.POS_X,t.POS_Y,t.FLOOR,1==t.IS_STAIR,t.NEIGHBOURS));for(let o of _Nodes)o.neighbourNodeList=_Nodes.filter(e=>o.NeighbourIDList.includes(e.ID))}async function getRoomList(){for(let e of((_Rooms=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getRooms"})})).sort((e,t)=>e.NAME>t.NAME?1:t.NAME>e.NAME?-1:0),_Rooms)){let t=[];for(let o of e.ALIASES)t.push(o.ALIAS);e.ALIASES=t}}function updateDropdown(e){initRoomDropdown(e.target.parentElement,e.target.value)}function initRoomDropdown(e,t){let o=e.querySelector(".option-container");for(let n of(o.innerHTML="",_Rooms)){let i=aliaslistMatch(n.ALIASES,t);if(t.trim().length<1||n.NAME.toLowerCase().includes(t.toLowerCase())||i.length>0){let s=document.createElement("li");if(s.classList="list-group-item",s.innerHTML=n.NAME,s.value=n.ID,n.ALIASES.length>0){let r=document.createElement("p");r.classList="m-0 p-0 text-muted",r.innerHTML=`(${n.ALIASES.join(", ")})`,s.appendChild(r)}s.addEventListener("click",dropdownItemClicked),o.appendChild(s)}}}function dropdownItemClicked(e){let t="LI"==e.target.tagName?e.target:e.target.parentElement,o=t.parentElement.parentElement.parentElement.querySelector(".selected-option-container"),n=_Rooms.find(e=>e.ID==t.value);o.innerHTML=n.NAME,o.value=n.ID,toggleDropdown({target:t.parentElement.parentElement})}function aliaslistMatch(e,t){let o=[];for(let n of e)n.toLowerCase().includes(t.toLowerCase())&&o.push(n);return o}function initCollapseBtns(){for(let e of document.getElementsByClassName("collapseBtnS"))e.addEventListener("click",toggleCollapse)}function toggleCollapse(){let e=document.getElementById("menuDiv");e.classList.contains("collapsed")?e.classList.remove("collapsed"):e.classList.add("collapsed")}function loadSVG(t){(_scene=new e.Scene).background=new e.Color(11579568),(_svg_loader=new o).load(t,function(t){let n=t.paths,i=new e.Group;i.scale.multiplyScalar(.5),i.scale.y*=-1;for(let s=0;s<n.length;s++){let r=n[s],a=r.userData.style.fill;if(_guiData.drawFillShapes&&void 0!==a&&"none"!==a){let l=new e.MeshBasicMaterial({color:new e.Color().setStyle(a),opacity:r.userData.style.fillOpacity,transparent:r.userData.style.fillOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),d=o.createShapes(r);for(let c=0;c<d.length;c++){let p=d[c],u=new e.ShapeGeometry(p),m=new e.Mesh(u,l);""!=r.userData.node.id&&createLabel(r,m,i),i.add(m)}}let g=r.userData.style.stroke;if(_guiData.drawStrokes&&void 0!==g&&"none"!==g){let h=new e.MeshBasicMaterial({color:new e.Color().setStyle(g),opacity:r.userData.style.strokeOpacity,transparent:r.userData.style.strokeOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let f=0,$=r.subPaths.length;f<$;f++){let y=r.subPaths[f],v=o.pointsToStroke(y.getPoints(),r.userData.style);if(v){let w=new e.Mesh(v,h);i.add(w)}}}}new e.Box3().setFromObject(i).getCenter(i.position).multiplyScalar(-1),_scene.add(i),setTimeout(()=>{document.getElementById("loadingSc").classList.add("hideLoading"),setTimeout(()=>{document.getElementById("loadingSc").style.display="none"},250)},250),_scene.add(i)})}function createLabel(t,o,s){let r=new n;r.load("./fonts/Open Sans_Regular.json",function(n){let r=t.userData.node.id.split("_x3B_")[0].replaceAll("_x2C_",",").replaceAll("_x28_","(").replaceAll("_x29_",")").replace(/_[0-9]*_/,"").replaceAll("_"," "),a=new i(r,{font:n,size:5,height:1,curveSegments:10,bevelEnabled:!1,bevelOffset:0,bevelSegments:1,bevelSize:.3,bevelThickness:1}),l=[new e.MeshPhongMaterial({color:16737792}),new e.MeshPhongMaterial({color:255})];var d=new e.Mesh(a,l);d.castShadow=!1;var c=o.geometry;c.computeBoundingBox();var p=new e.Vector3;c.boundingBox.getCenter(p);var u=d.geometry;u.computeBoundingBox();var m=u.boundingBox.min,g=u.boundingBox.max;d.position.x=p.x,d.position.x-=(g.x-m.x)/2,d.position.y=p.y,d.position.y+=(g.y-m.y)/3,d.scale.y*=-1,d.scale.z=.1;let h=new e.Vector3;c.boundingBox.getSize(h);let f=new e.Vector3;if(u.boundingBox.getSize(f),h.x<f.x){if(d.position.x=p.x,d.position.y=p.y,h.x<h.y){if(d.rotation.z=Math.PI/2,h.y<f.x){let $=Math.floor(h.y/f.x*10)/10.25;d.scale.x*=$,d.scale.y*=$,d.position.x-=(g.y-m.y)*$/3,d.position.y-=(g.x-m.x)*$/2}else d.position.x-=(g.y-m.y)/3,d.position.y-=(g.x-m.x)/2}else{let y=Math.floor(h.x/f.x*10)/10.25;d.scale.x*=y,d.scale.y*=y,d.position.x-=(g.x-m.x)*y/2,d.position.y+=(g.y-m.y)*y/3}}s.add(d)})}function showRoute(){if(!_Path||_Path.length<2)return;removeIcons(),drawLine([..._Path]),_Path[0].Floor==_guiData.currentFloor.number&&drawIcon("start_icon",new e.Vector3(_Path[0].PosX,_Path[0].PosY,-1));let t=_Path[_Path.length-1];t.Floor==_guiData.currentFloor.number&&drawIcon("dest_icon3",new e.Vector3(t.PosX,t.PosY,-1))}function drawIcon(t,o=new e.Vector3(0,0,.1)){let n=_Icons.find(e=>e.name==t);void 0!=n&&(_scene.add(n.group),n.visible=!0,n.position=o)}function removeIcons(){for(let e of _Icons)_scene.children.includes(e.group)&&(e.visible=!1,_scene.remove(e.group))}function loadIcons(){for(let e of["start_icon","dest_icon3"])_Icons.push(new ICON(e))}function loadIcon(t){(_svg_loader=new o).load(`./svg/icons/${t}.svg`,function(n){let i=n.paths,s=new e.Group;s.scale.multiplyScalar(.045),s.scale.y*=-1,s.name=t;for(let r=0;r<i.length;r++){let a=i[r],l=a.userData.style.fill,d=new e.MeshBasicMaterial({color:new e.Color().setStyle(l),opacity:a.userData.style.fillOpacity,transparent:a.userData.style.fillOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),c=o.createShapes(a);for(let p=0;p<c.length;p++){let u=c[p],m=new e.ShapeGeometry(u),g=new e.Mesh(m,d);s.add(g)}let h=a.userData.style.stroke,f=new e.MeshBasicMaterial({color:new e.Color().setStyle(h),opacity:a.userData.style.strokeOpacity,transparent:a.userData.style.strokeOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let $=0,y=a.subPaths.length;$<y;$++){let v=a.subPaths[$],w=o.pointsToStroke(v.getPoints(),a.userData.style);if(w){let D=new e.Mesh(w,f);s.add(D)}}}_Icons.push(s),_scene.add(s)})}function drawLine(t){if(t.length<2)return;for(let o of _Lines)_scene.remove(o);let n=[];for(;t.length>0;){let i=t.findIndex(e=>e.Floor!=t[0].Floor);i=i<0?t.length:i,n.push(t.splice(0,i))}let r=[];for(let l of n)if(l[0].Floor==_guiData.currentFloor.number){let d=[];for(let c of l)d.push(c.PosX,c.PosY,.05);r.push(d)}for(let p of r){let u=new s;u.setPositions(p),u.setColors(new e.Color(65280));let m=new a(u,lineMaterial);m.computeLineDistances(),m.scale.set(1,1,1),_Lines.push(m),_scene.add(m)}}function zoomModel(e,t){e?_controls.dollyIn(t):_controls.dollyOut(t)}function animate(){_controls.update(),lineMaterial.resolution.set(window.innerWidth,window.innerHeight),_renderer.render(_scene,_camera),window.requestAnimationFrame(animate)}function onWindowResize(){updateWindowSize(),_camera.aspect=window.outerWidth/window.outerHeight,_camera.updateProjectionMatrix(),_renderer.setSize(window.outerWidth,window.outerHeight)}function updateWindowSize(){mapDivWidth=window.innerWidth,mapDivHeight=window.innerHeight}async function createFloorBtns(){FloorURLs=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getFloors"})});let e=document.getElementById("floorBtnGroup");for(let t in FloorURLs){let o=document.createElement("button");o.value=t,o.innerHTML=FloorURLs[t].number,o.classList="btn text-dark btn-floor",1==FloorURLs[t].number&&o.classList.add("active"),o.addEventListener("click",changeFloor),e.appendChild(o)}}function changeFloor(e){if(FloorURLs[e.target.value].path!=_guiData.currentURL&&(document.getElementById("loadingSc").style.display="block",document.getElementById("loadingSc").classList.remove("hideLoading"),_controls.reset(),FloorURLs[e.target.value].path!=_guiData.currentURL)){for(let t of(removeIcons(),_guiData.currentFloor=FloorURLs[e.target.value],_guiData.currentURL=_guiData.currentFloor.path,loadSVG(_guiData.currentURL),document.querySelectorAll(".btn-floor")))t.classList.remove("active"),t.value==e.target.value&&t.classList.add("active");_renderer.render(_scene,_camera),showRoute(),_renderer.render(_scene,_camera)}}function swFromTo(){let e=document.getElementById("selected-option-from"),t=document.getElementById("selected-option-to");if(void 0==e.value&&void 0==t.value)return;let o=e.value,n=e.innerHTML;e.value=t.value,e.innerHTML=t.innerHTML,t.value=o,t.innerHTML=n,void 0==e.value&&(e.innerHTML="V\xe1lassza ki honnan indul"),void 0==t.value&&(t.innerHTML="V\xe1lassza ki hova szeretne eljutni")}function planRoute(e){e.preventDefault();let t=document.getElementById("selected-option-from").value,o=document.getElementById("selected-option-to").value;if(void 0==t||t<0||void 0==o||o<0)return;let n=_Rooms.find(e=>e.ID==t),i=_Rooms.find(e=>e.ID==o),s;_Path=bfs(_Nodes.find(e=>e.ID==n.NODE_ID),_Nodes.find(e=>e.ID==i.NODE_ID)),_guiData.currentFloor.number==_Path[0].Floor?showRoute():changeFloor({target:{value:FloorURLs.findIndex(e=>e.number==_Path[0].Floor)}}),toggleCollapse()}async function getData(e,t){let o;return await (o=t?await fetch(e,t):await fetch(e)).json()}function bfs(e,t){var o=[250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265];for(let n of((o.includes(parseInt(e.ID))||o.includes(parseInt(t.ID)))&&(o=[]),_Nodes))n.isVisited=!1,n.prevNode=null;let i=[e];for(e.isVisited=!0;0==!i.length;){let s=i.splice(0,1)[0];for(let r of s.neighbourNodeList.filter(e=>!o.includes(parseInt(e.ID))))r.isVisited||(i.push(r),r.isVisited=!0,r.prevNode=s)}let a=[];for(let l=t;null!=l;l=l.prevNode)a.push(l);return(a.reverse(),a[0]==e)?a:[]}window.addEventListener("resize",onWindowResize),window.addEventListener("load",init);class NODE{constructor(e,t,o,n,i=!1,s=[]){for(let r of(this.ID=e,this.PosX=parseFloat(t),this.PosY=parseFloat(o),this.Floor=n,this.IsStair=i,this.NeighbourIDList=[],s))this.NeighbourIDList.push(r.ID);this.neighbourNodeList=[]}}class ICON{constructor(t,o=0,n=0){this.offsetX=4.73,this.offsetY=11.75,this.group=new e.Group,this.loadSVGFile(t,o,n)}loadSVGFile(t,n,i){_svg_loader=new o,this.group=new e.Group,this.group.scale.multiplyScalar(.055),this.group.scale.y*=-1,this.group.visible=!1,this.group.renderOrder=99,this.group.name=t,_svg_loader.loadAsync(`./svg/icons/${t}.svg`).then(t=>{this.loaderFunction(t),this.position=new e.Vector3(n,i,.25)})}loaderFunction(t){let n=t.paths;for(let i=0;i<n.length;i++){let s=n[i],r=s.userData.style.fill,a=new e.MeshBasicMaterial({color:new e.Color().setStyle(r),opacity:s.userData.style.fillOpacity,transparent:s.userData.style.fillOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),l=o.createShapes(s);for(let d=0;d<l.length;d++){let c=l[d],p=new e.ShapeGeometry(c),u=new e.Mesh(p,a);this.group.add(u)}let m=s.userData.style.stroke,g=new e.MeshBasicMaterial({color:new e.Color().setStyle(m),opacity:s.userData.style.strokeOpacity,transparent:s.userData.style.strokeOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let h=0,f=s.subPaths.length;h<f;h++){let $=s.subPaths[h],y=o.pointsToStroke($.getPoints(),s.userData.style);if(y){let v=new e.Mesh(y,g);this.group.add(v)}}}}get name(){return this.group.name}get position(){return this.group.position}set position(e){this.group.position.set(e.x-this.offsetX,e.y+this.offsetY,.1)}get visible(){return this.group.visible}set visible(e){this.group.visible=e}}