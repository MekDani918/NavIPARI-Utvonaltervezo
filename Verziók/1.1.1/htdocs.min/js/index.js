import*as e from"https://cdn.skypack.dev/-/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/dist=es2020,mode=imports,min/optimized/three.js";import{OrbitControls as t}from"./OrbitControls.js";import{SVGLoader as o}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/SVGLoader.js";import{FontLoader as n}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/loaders/FontLoader.js";import{TextGeometry as r}from"https://cdn.skypack.dev/pin/three@v0.135.0-pjGUcRG9Xt70OdXl97VF/mode=imports,min/unoptimized/examples/jsm/geometries/TextGeometry.js";var mapDivWidth,mapDivHeight,_scene,_camera,_renderer,_controls,cube,_svg_loader,_guiData,FloorURLs=["./svg/001-foldszint.svg","./svg/002-emelet1.svg","./svg/003-emelet2.svg","./svg/004-I-epulet-padlaster.svg"],_Animators=[],lastZoomVal=0,_Rooms=[],_Nodes=[],_Path=[],_Lines=[],_Icons=[];async function init(){updateWindowSize(),_scene=new e.Scene,_camera=new e.PerspectiveCamera(75,window.outerWidth/window.outerHeight,1,1e3),(_renderer=new e.WebGLRenderer({antialias:!0})).setPixelRatio(window.devicePixelRatio),_renderer.setSize(window.outerWidth,window.outerHeight),document.getElementById("mapDiv").appendChild(_renderer.domElement),_camera.position.z=200,_camera.lookAt(0,0,0),(_controls=new t(_camera,_renderer.domElement)).enableRotate=!1,_controls.minDistance=25,_controls.maxDistance=500,_controls.zoomSpeed=2,_controls.mouseButtons={LEFT:e.MOUSE.PAN,MIDDLE:e.MOUSE.DOLLY,RIGHT:e.MOUSE.PAN},_controls.touches={ONE:e.TOUCH.PAN,TWO:e.TOUCH.DOLLY_PAN},loadSVG((_guiData={currentURL:"./svg/001-foldszint.svg",currentFloor:{number:1,path:"./svg/001-foldszint.svg"},drawFillShapes:!0,drawStrokes:!0,fillShapesWireframe:!1,strokesWireframe:!1}).currentURL),loadIcons(),document.getElementById("zoomBtnGroup").addEventListener("click",e=>{zoomModel("+"==("svg"==e.target.tagName?e.target.parentElement:"path"==e.target.tagName?e.target.parentElement.parentElement:e.target).value,.95*_controls.getZoomScale())}),window.requestAnimationFrame(animate),await createFloorBtns(),initCollapseBtns(),await getNodeList(),await getRoomList(),document.getElementById("selected-option-from").addEventListener("click",toggleDropdown),document.getElementById("fromPlace").addEventListener("input",updateDropdown),document.getElementById("selected-option-to").addEventListener("click",toggleDropdown),document.getElementById("toPlace").addEventListener("input",updateDropdown),document.getElementById("swFromTo").addEventListener("click",swFromTo),document.getElementById("planRoute").addEventListener("click",planRoute),showRoute()}function toggleDropdown(e){let t=e.target.parentElement.getElementsByClassName("dropdown-container")[0];for(let o of document.getElementsByClassName("dropdown-container"))o!=t&&o.classList.contains("dropdown-visible")&&o.classList.remove("dropdown-visible");let n=t.querySelector(".form-control");t.classList.contains("dropdown-visible")||(initRoomDropdown(t,""),n.value=""),t.classList.toggle("dropdown-visible"),n.focus()}async function getNodeList(){let e=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getNodes"})});for(let t of e)_Nodes.push(new NODE(t.ID,t.POS_X,t.POS_Y,t.FLOOR,1==t.IS_STAIR,t.NEIGHBOURS));for(let o of _Nodes)o.neighbourNodeList=_Nodes.filter(e=>o.NeighbourIDList.includes(e.ID))}async function getRoomList(){for(let e of((_Rooms=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getRooms"})})).sort((e,t)=>e.NAME>t.NAME?1:t.NAME>e.NAME?-1:0),_Rooms)){let t=[];for(let o of e.ALIASES)t.push(o.ALIAS);e.ALIASES=t}}function updateDropdown(e){initRoomDropdown(e.target.parentElement,e.target.value)}function initRoomDropdown(e,t){let o=e.querySelector(".option-container");for(let n of(o.innerHTML="",_Rooms)){let r=aliaslistMatch(n.ALIASES,t);if(t.trim().length<1||n.NAME.toLowerCase().includes(t.toLowerCase())||r.length>0){let i=document.createElement("li");if(i.classList="list-group-item",i.innerHTML=n.NAME,i.value=n.ID,n.ALIASES.length>0){let s=document.createElement("p");s.classList="m-0 p-0 text-muted",s.innerHTML=`(${n.ALIASES.join(", ")})`,i.appendChild(s)}i.addEventListener("click",dropdownItemClicked),o.appendChild(i)}}}function dropdownItemClicked(e){let t="LI"==e.target.tagName?e.target:e.target.parentElement,o=t.parentElement.parentElement.parentElement.querySelector(".selected-option-container"),n=_Rooms.find(e=>e.ID==t.value);o.innerHTML=n.NAME,o.value=n.ID,toggleDropdown({target:t.parentElement.parentElement})}function aliaslistMatch(e,t){let o=[];for(let n of e)n.toLowerCase().includes(t.toLowerCase())&&o.push(n);return o}function initCollapseBtns(){for(let e of document.getElementsByClassName("collapseBtnS"))e.addEventListener("click",toggleCollapse)}function toggleCollapse(){let e=document.getElementById("menuDiv");e.classList.contains("collapsed")?e.classList.remove("collapsed"):e.classList.add("collapsed")}function loadSVG(t){(_scene=new e.Scene).background=new e.Color(11579568),(_svg_loader=new o).load(t,function(t){let n=t.paths,r=new e.Group;r.scale.multiplyScalar(.5),r.scale.y*=-1;for(let i=0;i<n.length;i++){let s=n[i],a=s.userData.style.fill;if(_guiData.drawFillShapes&&void 0!==a&&"none"!==a){let l=new e.MeshBasicMaterial({color:new e.Color().setStyle(a),opacity:s.userData.style.fillOpacity,transparent:s.userData.style.fillOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),d=o.createShapes(s);for(let c=0;c<d.length;c++){let u=d[c],p=new e.ShapeGeometry(u),m=new e.Mesh(p,l);""!=s.userData.node.id&&createLabel(s,m,r),r.add(m)}}let g=s.userData.style.stroke;if(_guiData.drawStrokes&&void 0!==g&&"none"!==g){let f=new e.MeshBasicMaterial({color:new e.Color().setStyle(g),opacity:s.userData.style.strokeOpacity,transparent:s.userData.style.strokeOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let h=0,v=s.subPaths.length;h<v;h++){let $=s.subPaths[h],y=o.pointsToStroke($.getPoints(),s.userData.style);if(y){let w=new e.Mesh(y,f);r.add(w)}}}}new e.Box3().setFromObject(r).getCenter(r.position).multiplyScalar(-1),_scene.add(r),setTimeout(()=>{document.getElementById("loadingSc").classList.add("hideLoading"),setTimeout(()=>{document.getElementById("loadingSc").style.display="none"},250)},250),_scene.add(r)})}function createLabel(t,o,i){let s=new n;s.load("./fonts/Open Sans_Regular.json",function(n){let s=t.userData.node.id.split("_x3B_")[0].replaceAll("_x2C_",",").replaceAll("_x28_","(").replaceAll("_x29_",")").replace(/_[0-9]*_/,"").replaceAll("_"," "),a=new r(s,{font:n,size:5,height:1,curveSegments:10,bevelEnabled:!1,bevelOffset:0,bevelSegments:1,bevelSize:.3,bevelThickness:1}),l=[new e.MeshPhongMaterial({color:16737792}),new e.MeshPhongMaterial({color:255})];var d=new e.Mesh(a,l);d.castShadow=!1;var c=o.geometry;c.computeBoundingBox();var u=new e.Vector3;c.boundingBox.getCenter(u);var p=d.geometry;p.computeBoundingBox();var m=p.boundingBox.min,g=p.boundingBox.max;d.position.x=u.x,d.position.x-=(g.x-m.x)/2,d.position.y=u.y,d.position.y+=(g.y-m.y)/3,d.scale.y*=-1,d.scale.z=.1;let f=new e.Vector3;c.boundingBox.getSize(f);let h=new e.Vector3;if(p.boundingBox.getSize(h),f.x<h.x){if(d.position.x=u.x,d.position.y=u.y,f.x<f.y){if(d.rotation.z=Math.PI/2,f.y<h.x){let v=Math.floor(f.y/h.x*10)/10.25;d.scale.x*=v,d.scale.y*=v,d.position.x-=(g.y-m.y)*v/3,d.position.y-=(g.x-m.x)*v/2}else d.position.x-=(g.y-m.y)/3,d.position.y-=(g.x-m.x)/2}else{let $=Math.floor(f.x/h.x*10)/10.25;d.scale.x*=$,d.scale.y*=$,d.position.x-=(g.x-m.x)*$/2,d.position.y+=(g.y-m.y)*$/3}}i.add(d)})}function showRoute(){if(!_Path||_Path.length<2)return;removeIcons(),drawLine([..._Path]),_Path[0].Floor==_guiData.currentFloor.number&&drawIcon("start_icon",new e.Vector3(_Path[0].PosX,_Path[0].PosY,-1));let t=_Path[_Path.length-1];t.Floor==_guiData.currentFloor.number&&drawIcon("dest_icon3",new e.Vector3(t.PosX,t.PosY,-1))}function drawIcon(t,o=new e.Vector3(0,0,.1)){let n=_Icons.find(e=>e.name==t);void 0!=n&&(_scene.add(n.group),n.visible=!0,n.position=o)}function removeIcons(){for(let e of _Icons)_scene.children.includes(e.group)&&(e.visible=!1,_scene.remove(e.group))}function loadIcons(){for(let e of["start_icon","dest_icon3"])_Icons.push(new ICON(e))}function drawLine(e){if(e.length<2)return;for(let t of _Lines)_scene.remove(t);for(let o of _Animators)o.stop();let n=[];for(;e.length>0;){let r=e.findIndex(t=>t.Floor!=e[0].Floor);r=r<0?e.length:r,n.push(e.splice(0,r))}for(let i of(_Lines=[],_Animators=[],n))i[0].Floor==_guiData.currentFloor.number&&dipsLine(i,3)}function dipsLine(t,o=2){for(let n=1;n<t.length;n++){var r=new e.Vector2(t[n].PosX-t[n-1].PosX,t[n].PosY-t[n-1].PosY),i=Math.sqrt(Math.pow(r.x,2)+Math.pow(r.y,2)),s=new e.TextureLoader().load("img/run.png"),a=new TextureAnimator(s,10,75),l=new e.MeshBasicMaterial({map:s,side:e.DoubleSide,transparent:!0});s.repeat.y=1,s.repeat.x=.05*i;var d=new e.PlaneGeometry(i,o,1,1),c=new e.Mesh(d,l),u=(t[n-1].PosX+t[n].PosX)/2,p=(t[n-1].PosY+t[n].PosY)/2;c.position.set(u,p);var m=new e.Vector2(1,0),g=Math.atan2(r.x*m.y-r.y*m.x,r.x*m.x+r.y*m.y);Math.abs(g)>Math.PI/4&&Math.abs(g)<3*Math.PI/4&&(g+=Math.PI),c.rotation.set(0,0,g),_Lines.push(c),_scene.add(c),_Animators.push(a)}}function zoomModel(e,t){e?_controls.dollyIn(t):_controls.dollyOut(t)}function animate(){_controls.update(),_renderer.render(_scene,_camera),window.requestAnimationFrame(animate)}function TextureAnimator(t,o,n){let r={};return r.texture=t,r.frameDuration=n,r.numberOfTiles=o,r.texture.wrapS=e.RepeatWrapping,r.texture.wrapT=e.RepeatWrapping,r.texture.repeat.set(1/o,1),r.currentTile=0,r.nextFrame=function(){r.currentTile++,r.currentTile==r.numberOfTiles&&(r.currentTile=0);let e=r.currentTile%r.numberOfTiles;r.texture.offset.x=e/r.numberOfTiles},r.start=function(){r.intervalID=setInterval(r.nextFrame,r.frameDuration)},r.stop=function(){clearInterval(r.intervalID)},r.start(),r}function onWindowResize(){updateWindowSize(),_camera.aspect=window.outerWidth/window.outerHeight,_camera.updateProjectionMatrix(),_renderer.setSize(window.outerWidth,window.outerHeight)}function updateWindowSize(){mapDivWidth=window.innerWidth,mapDivHeight=window.innerHeight}async function createFloorBtns(){FloorURLs=await getData("./php/API.php",{method:"POST",body:JSON.stringify({function:"getFloors"})});let e=document.getElementById("floorBtnGroup");for(let t in FloorURLs){let o=document.createElement("button");o.value=t,o.innerHTML=FloorURLs[t].number,o.classList="btn text-dark btn-floor",1==FloorURLs[t].number&&o.classList.add("active"),o.addEventListener("click",changeFloor),e.appendChild(o)}}function changeFloor(e){if(FloorURLs[e.target.value].path!=_guiData.currentURL&&(document.getElementById("loadingSc").style.display="block",document.getElementById("loadingSc").classList.remove("hideLoading"),_controls.reset(),FloorURLs[e.target.value].path!=_guiData.currentURL)){for(let t of(removeIcons(),_guiData.currentFloor=FloorURLs[e.target.value],_guiData.currentURL=_guiData.currentFloor.path,loadSVG(_guiData.currentURL),document.querySelectorAll(".btn-floor")))t.classList.remove("active"),t.value==e.target.value&&t.classList.add("active");_renderer.render(_scene,_camera),showRoute(),_renderer.render(_scene,_camera)}}function swFromTo(){let e=document.getElementById("selected-option-from"),t=document.getElementById("selected-option-to");if(void 0==e.value&&void 0==t.value)return;let o=e.value,n=e.innerHTML;e.value=t.value,e.innerHTML=t.innerHTML,t.value=o,t.innerHTML=n,void 0==e.value&&(e.innerHTML="V\xe1lassza ki honnan indul"),void 0==t.value&&(t.innerHTML="V\xe1lassza ki hova szeretne eljutni")}function planRoute(e){e.preventDefault();let t=document.getElementById("selected-option-from").value,o=document.getElementById("selected-option-to").value;if(void 0==t||t<0||void 0==o||o<0)return;let n=_Rooms.find(e=>e.ID==t),r=_Rooms.find(e=>e.ID==o),i;_Path=bfs(_Nodes.find(e=>e.ID==n.NODE_ID),_Nodes.find(e=>e.ID==r.NODE_ID)),_guiData.currentFloor.number==_Path[0].Floor?showRoute():changeFloor({target:{value:FloorURLs.findIndex(e=>e.number==_Path[0].Floor)}}),toggleCollapse()}async function getData(e,t){let o;return await (o=t?await fetch(e,t):await fetch(e)).json()}function bfs(e,t){var o=[250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265];for(let n of((o.includes(parseInt(e.ID))||o.includes(parseInt(t.ID)))&&(o=[]),_Nodes))n.isVisited=!1,n.prevNode=null;let r=[e];for(e.isVisited=!0;0==!r.length;){let i=r.splice(0,1)[0];for(let s of i.neighbourNodeList.filter(e=>!o.includes(parseInt(e.ID))))s.isVisited||(r.push(s),s.isVisited=!0,s.prevNode=i)}let a=[];for(let l=t;null!=l;l=l.prevNode)a.push(l);return(a.reverse(),a[0]==e)?a:[]}window.addEventListener("resize",onWindowResize),window.addEventListener("load",init);class NODE{constructor(e,t,o,n,r=!1,i=[]){for(let s of(this.ID=e,this.PosX=parseFloat(t),this.PosY=parseFloat(o),this.Floor=n,this.IsStair=r,this.NeighbourIDList=[],i))this.NeighbourIDList.push(s.ID);this.neighbourNodeList=[]}}class ICON{constructor(t,o=0,n=0){this.offsetX=4.73,this.offsetY=11.75,this.group=new e.Group,this.loadSVGFile(t,o,n)}loadSVGFile(t,n,r){_svg_loader=new o,this.group=new e.Group,this.group.scale.multiplyScalar(.055),this.group.scale.y*=-1,this.group.visible=!1,this.group.renderOrder=99,this.group.name=t,_svg_loader.loadAsync(`./svg/icons/${t}.svg`).then(t=>{this.loaderFunction(t),this.position=new e.Vector3(n,r,.25)})}loaderFunction(t){let n=t.paths;for(let r=0;r<n.length;r++){let i=n[r],s=i.userData.style.fill,a=new e.MeshBasicMaterial({color:new e.Color().setStyle(s),opacity:i.userData.style.fillOpacity,transparent:i.userData.style.fillOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.fillShapesWireframe}),l=o.createShapes(i);for(let d=0;d<l.length;d++){let c=l[d],u=new e.ShapeGeometry(c),p=new e.Mesh(u,a);this.group.add(p)}let m=i.userData.style.stroke,g=new e.MeshBasicMaterial({color:new e.Color().setStyle(m),opacity:i.userData.style.strokeOpacity,transparent:i.userData.style.strokeOpacity<1,side:e.DoubleSide,depthWrite:!1,wireframe:_guiData.strokesWireframe});for(let f=0,h=i.subPaths.length;f<h;f++){let v=i.subPaths[f],$=o.pointsToStroke(v.getPoints(),i.userData.style);if($){let y=new e.Mesh($,g);this.group.add(y)}}}}get name(){return this.group.name}get position(){return this.group.position}set position(e){this.group.position.set(e.x-this.offsetX,e.y+this.offsetY,.1)}get visible(){return this.group.visible}set visible(e){this.group.visible=e}}